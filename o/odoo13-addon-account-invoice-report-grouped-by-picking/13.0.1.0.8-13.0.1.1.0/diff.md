# Comparing `tmp/odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8-py3-none-any.whl.zip` & `tmp/odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,23 +1,22 @@
-Zip file size: 29892 bytes, number of entries: 21
--rw-r--r--  2.0 unx     4017 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/README.rst
--rw-r--r--  2.0 unx       21 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/__init__.py
--rw-r--r--  2.0 unx      662 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py
--rw-r--r--  2.0 unx     1431 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/i18n/account_invoice_report_grouped_by_picking.pot
--rw-r--r--  2.0 unx     1769 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/i18n/es.po
--rw-r--r--  2.0 unx     1669 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/i18n/pt.po
--rw-r--r--  2.0 unx       27 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/models/__init__.py
--rw-r--r--  2.0 unx     3405 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py
--rw-r--r--  2.0 unx      195 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      317 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx      302 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/readme/ROADMAP.rst
--rw-r--r--  2.0 unx      338 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst
--rw-r--r--  2.0 unx     9455 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png
--rw-r--r--  2.0 unx    13692 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html
--rw-r--r--  2.0 unx       49 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/tests/__init__.py
--rw-r--r--  2.0 unx    11251 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py
--rw-r--r--  2.0 unx     6425 b- defN 22-Nov-16 19:42 odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml
--rw-r--r--  2.0 unx     4662 b- defN 22-Nov-16 19:43 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Nov-16 19:43 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 22-Nov-16 19:43 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2748 b- defN 22-Nov-16 19:43 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/RECORD
-21 files, 62532 bytes uncompressed, 25036 bytes compressed:  60.0%
+Zip file size: 29357 bytes, number of entries: 20
+-rw-r--r--  2.0 unx     3667 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/README.rst
+-rw-r--r--  2.0 unx       21 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/__init__.py
+-rw-r--r--  2.0 unx      662 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py
+-rw-r--r--  2.0 unx     1431 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/i18n/account_invoice_report_grouped_by_picking.pot
+-rw-r--r--  2.0 unx     1769 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/i18n/es.po
+-rw-r--r--  2.0 unx     1669 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/i18n/pt.po
+-rw-r--r--  2.0 unx       27 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/models/__init__.py
+-rw-r--r--  2.0 unx     5775 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py
+-rw-r--r--  2.0 unx      195 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      317 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx      338 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png
+-rw-r--r--  2.0 unx    13122 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html
+-rw-r--r--  2.0 unx       49 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/tests/__init__.py
+-rw-r--r--  2.0 unx    11251 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py
+-rw-r--r--  2.0 unx     5730 b- defN 23-May-17 19:30 odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml
+-rw-r--r--  2.0 unx     4312 b- defN 23-May-17 19:30 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-17 19:30 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-May-17 19:30 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2620 b- defN 23-May-17 19:30 odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/RECORD
+20 files, 62507 bytes uncompressed, 24721 bytes compressed:  60.5%
```

## zipnote {}

```diff
@@ -24,17 +24,14 @@
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst
 Comment: 
 
-Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/ROADMAP.rst
-Comment: 
-
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html
@@ -45,20 +42,20 @@
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml
 Comment: 
 
-Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/METADATA
+Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/METADATA
 Comment: 
 
-Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/WHEEL
+Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/WHEEL
 Comment: 
 
-Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/top_level.txt
+Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/RECORD
+Filename: odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/account_invoice_report_grouped_by_picking/README.rst

```diff
@@ -45,22 +45,14 @@
 #. Deliver pickings related to each sale order.
 #. Go to *Sales > Invoicing > Sales to invoicing* and invoice these sale
    orders.
 #. Open invoice newly created and print it.
 #. Invoice report will group invoice lines and shows information about sales
    and pickings in every group.
 
-Known issues / Roadmap
-======================
-
-* As a result of the grouping by pickings, we don't support notes and descriptions.
-* Anyways, an invoice with no pickings should be printed as usual. The problem is
-  that in the current state of the report, a heavy refactoring is needed to be able to
-  fallback to the regular behavior in such case.
-
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/account-invoice-reporting/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
 `feedback <https://github.com/OCA/account-invoice-reporting/issues/new?body=module:%20account_invoice_report_grouped_by_picking%0Aversion:%2013.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
```

## odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py

```diff
@@ -2,15 +2,15 @@
 # Copyright 2018 David Vidal <david.vidal@tecnativa.com>
 # Copyright 2018-2019 Tecnativa - Pedro M. Baeza
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
 {
     "name": "Account Invoice Grouped by Picking",
     "summary": "Print invoice lines grouped by picking",
-    "version": "13.0.1.0.8",
+    "version": "13.0.1.1.0",
     "category": "Accounting & Finance",
     "website": "https://github.com/OCA/account-invoice-reporting",
     "author": "Tecnativa, " "Odoo Community Association (OCA)",
     "license": "AGPL-3",
     "depends": ["stock_picking_invoice_link"],
     "data": ["views/report_invoice.xml"],
 }
```

## odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py

```diff
@@ -1,47 +1,62 @@
-# Copyright 2017 Tecnativa - Carlos Dauden
+# Copyright 2017-2023 Tecnativa - Carlos Dauden
 # Copyright 2018 Tecnativa - David Vidal
 # Copyright 2018-2019 Tecnativa - Pedro M. Baeza
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
-
+import datetime
 from collections import OrderedDict
 
 from odoo import api, models
 from odoo.tools import float_is_zero
 
 
 class AccountMove(models.Model):
     _inherit = "account.move"
 
     @api.model
     def _sort_grouped_lines(self, lines_dic):
+        min_date = datetime.datetime.min
         return sorted(
             lines_dic,
             key=lambda x: (
-                (x["picking"].date, x["picking"].date_done or x["picking"].date)
+                (
+                    x["picking"].date or min_date,
+                    x["picking"].date_done or x["picking"].date or min_date,
+                )
             ),
         )
 
     def _get_signed_quantity_done(self, invoice_line, move, sign):
         """Hook method. Usage example:
         account_invoice_report_grouped_by_picking_sale_mrp module
         """
         qty = 0
         if move.location_id.usage == "customer":
             qty = -move.quantity_done * sign
         elif move.location_dest_id.usage == "customer":
             qty = move.quantity_done * sign
         return qty
 
+    def _process_section_note_lines_grouped(
+        self, previous_section, previous_note, lines_dic, pick_order=None
+    ):
+        key_section = (pick_order, previous_section) if pick_order else previous_section
+        if previous_section and key_section not in lines_dic:
+            lines_dic[key_section] = 0.0
+        key_note = (pick_order, previous_note) if pick_order else previous_note
+        if previous_note and key_note not in lines_dic:
+            lines_dic[key_note] = 0.0
+
     def lines_grouped_by_picking(self):
         """This prepares a data structure for printing the invoice report
         grouped by pickings."""
         self.ensure_one()
         picking_dict = OrderedDict()
         lines_dict = OrderedDict()
+        picking_obj = self.env["stock.picking"]
         # Not change sign if the credit note has been created from reverse move option
         # and it has the same pickings related than the reversed invoice instead of sale
         # order invoicing process after picking reverse transfer
         sign = (
             -1.0
             if self.type == "out_refund"
             and (
@@ -49,37 +64,73 @@
                 or self.reversed_entry_id.picking_ids != self.picking_ids
             )
             else 1.0
         )
         # Let's get first a correspondance between pickings and sales order
         so_dict = {x.sale_id: x for x in self.picking_ids if x.sale_id}
         # Now group by picking by direct link or via same SO as picking's one
-        for line in self.invoice_line_ids.filtered(lambda x: not x.display_type):
+        previous_section = previous_note = False
+        for line in self.invoice_line_ids.sorted(
+            lambda ln: (-ln.sequence, ln.date, ln.move_name, -ln.id), reverse=True
+        ):
+            if line.display_type == "line_section":
+                previous_section = line
+                continue
+            if line.display_type == "line_note":
+                previous_note = line
+                continue
+            has_returned_qty = False
             remaining_qty = line.quantity
             for move in line.move_line_ids:
                 key = (move.picking_id, line)
+                self._process_section_note_lines_grouped(
+                    previous_section, previous_note, picking_dict, move.picking_id
+                )
                 picking_dict.setdefault(key, 0)
+                if move.location_id.usage == "customer":
+                    has_returned_qty = True
                 qty = self._get_signed_quantity_done(line, move, sign)
                 picking_dict[key] += qty
                 remaining_qty -= qty
             if not line.move_line_ids and line.sale_line_ids:
                 for so_line in line.sale_line_ids:
                     if so_dict.get(so_line.order_id):
                         key = (so_dict[so_line.order_id], line)
+                        self._process_section_note_lines_grouped(
+                            previous_section,
+                            previous_note,
+                            picking_dict,
+                            so_dict[so_line.order_id],
+                        )
                         picking_dict.setdefault(key, 0)
                         qty = so_line.product_uom_qty
                         picking_dict[key] += qty
                         remaining_qty -= qty
+            elif not line.move_line_ids and not line.sale_line_ids:
+                key = (picking_obj, line)
+                picking_dict.setdefault(key, 0)
+                qty = line.quantity
+                picking_dict[key] += qty
+                remaining_qty -= qty
+            # To avoid to print duplicate lines because the invoice is a refund
+            # without returned goods to refund.
+            if self.type == "out_refund" and not has_returned_qty and remaining_qty:
+                remaining_qty = 0.0
+                for key in picking_dict:
+                    picking_dict[key] = abs(picking_dict[key])
             if not float_is_zero(
                 remaining_qty,
                 precision_rounding=line.product_id.uom_id.rounding or 0.01,
             ):
+                self._process_section_note_lines_grouped(
+                    previous_section, previous_note, lines_dict
+                )
                 lines_dict[line] = remaining_qty
         no_picking = [
-            {"picking": False, "line": key, "quantity": value}
+            {"picking": picking_obj, "line": key, "quantity": value}
             for key, value in lines_dict.items()
         ]
         with_picking = [
             {"picking": key[0], "line": key[1], "quantity": value}
             for key, value in picking_dict.items()
         ]
         return no_picking + self._sort_grouped_lines(with_picking)
```

## odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html

### odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html

```diff
@@ -392,30 +392,27 @@
       </p>
       <div class="contents local topic" id="contents">
         <ul class="simple">
           <li>
             <a class="reference internal" href="#usage" id="id1">Usage</a>
           </li>
           <li>
-            <a class="reference internal" href="#known-issues-roadmap" id="id2">Known issues / Roadmap</a>
+            <a class="reference internal" href="#bug-tracker" id="id2">Bug Tracker</a>
           </li>
           <li>
-            <a class="reference internal" href="#bug-tracker" id="id3">Bug Tracker</a>
-          </li>
-          <li>
-            <a class="reference internal" href="#credits" id="id4">Credits</a>
+            <a class="reference internal" href="#credits" id="id3">Credits</a>
             <ul>
               <li>
-                <a class="reference internal" href="#authors" id="id5">Authors</a>
+                <a class="reference internal" href="#authors" id="id4">Authors</a>
               </li>
               <li>
-                <a class="reference internal" href="#contributors" id="id6">Contributors</a>
+                <a class="reference internal" href="#contributors" id="id5">Contributors</a>
               </li>
               <li>
-                <a class="reference internal" href="#maintainers" id="id7">Maintainers</a>
+                <a class="reference internal" href="#maintainers" id="id6">Maintainers</a>
               </li>
             </ul>
           </li>
         </ul>
       </div>
       <div class="section" id="usage">
         <h1>
@@ -431,55 +428,44 @@
 orders.
           </li>
           <li>Open invoice newly created and print it.</li>
           <li>Invoice report will group invoice lines and shows information about sales
 and pickings in every group.</li>
         </ol>
       </div>
-      <div class="section" id="known-issues-roadmap">
-        <h1>
-          <a class="toc-backref" href="#id2">Known issues / Roadmap</a>
-        </h1>
-        <ul class="simple">
-          <li>As a result of the grouping by pickings, we donâ€™t support notes and descriptions.</li>
-          <li>Anyways, an invoice with no pickings should be printed as usual. The problem is
-that in the current state of the report, a heavy refactoring is needed to be able to
-fallback to the regular behavior in such case.</li>
-        </ul>
-      </div>
       <div class="section" id="bug-tracker">
         <h1>
-          <a class="toc-backref" href="#id3">Bug Tracker</a>
+          <a class="toc-backref" href="#id2">Bug Tracker</a>
         </h1>
         <p>
           Bugs are tracked on
           <a class="reference external" href="https://github.com/OCA/account-invoice-reporting/issues">GitHub Issues</a>
           .
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
           <a class="reference external" href="https://github.com/OCA/account-invoice-reporting/issues/new?body=module:%20account_invoice_report_grouped_by_picking%0Aversion:%2013.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**">feedback</a>
           .
         </p>
         <p>Do not contact contributors directly about support or help with technical issues.</p>
       </div>
       <div class="section" id="credits">
         <h1>
-          <a class="toc-backref" href="#id4">Credits</a>
+          <a class="toc-backref" href="#id3">Credits</a>
         </h1>
         <div class="section" id="authors">
           <h2>
-            <a class="toc-backref" href="#id5">Authors</a>
+            <a class="toc-backref" href="#id4">Authors</a>
           </h2>
           <ul class="simple">
             <li>Tecnativa</li>
           </ul>
         </div>
         <div class="section" id="contributors">
           <h2>
-            <a class="toc-backref" href="#id6">Contributors</a>
+            <a class="toc-backref" href="#id5">Contributors</a>
           </h2>
           <ul class="simple">
             <li>
               <a class="reference external" href="https://www.tecnativa.com">Tecnativa</a>
               :
               <ul>
                 <li>Carlos Dauden</li>
@@ -499,15 +485,15 @@
                 </li>
               </ul>
             </li>
           </ul>
         </div>
         <div class="section" id="maintainers">
           <h2>
-            <a class="toc-backref" href="#id7">Maintainers</a>
+            <a class="toc-backref" href="#id6">Maintainers</a>
           </h2>
           <p>This module is maintained by the OCA.</p>
           <a class="reference external image-reference" href="https://odoo-community.org">
             <img alt="Odoo Community Association" src="https://odoo-community.org/logo.png"/>
           </a>
           <p>OCA, or the Odoo Community Association, is a nonprofit organization whose
 mission is to support the collaborative development of Odoo features and
```

## odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml

### odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml

```diff
@@ -1,27 +1,32 @@
 <?xml version="1.0" encoding="utf-8"?>
 <odoo>
   <template id="report_invoice_document" inherit_id="account.report_invoice_document" priority="99">
+    <xpath expr="//t[@t-set='o']" position="after">
+      <t t-set="lines_grouped" t-value="o.lines_grouped_by_picking()"/>
+    </xpath>
     <xpath expr="//t[contains(@t-foreach, 'lines')]/t[3]" position="replace"/>
     <xpath expr="//tbody[hasclass('invoice_tbody')]" position="inside">
       <t t-set="subtotal" t-value="0.0"/>
-      <t t-set="lines_grouped" t-value="o.lines_grouped_by_picking()"/>
     </xpath>
     <xpath expr="//t[contains(@t-foreach, 'lines')]" position="attributes">
-      <attribute name="t-foreach">o.lines_grouped_by_picking()</attribute>
+      <attribute name="t-foreach">lines_grouped</attribute>
       <attribute name="t-as">lines_group</attribute>
     </xpath>
     <!-- Appends before 'current_subtotal' compute -->
     <xpath expr="//t[@groups='account.group_show_line_subtotals_tax_excluded']" position="before">
       <t t-set="l" t-value="lines_group['line']"/>
       <t t-set="line" t-value="lines_group['line']"/>
       <t t-set="picking" t-value="lines_group['picking']"/>
-      <t t-set="lines_grouped" t-value="o.lines_grouped_by_picking()"/>
       <t t-set="next_picking" t-value="[lines_grouped[i + 1]['picking'] for i, x in enumerate(lines_grouped) if x == lines_group and i &lt; len(lines_grouped) - 1] or [False]"/>
+      <!-- Avoid to show original subtotal -->
+      <t t-set="line_last" t-value="False"/>
+      <t t-set="line_index" t-value="0"/>
       <t t-if="picking != last_picking">
+        <t t-set="last_picking" t-value="picking"/>
         <tr t-if="picking">
           <td colspan="10">
             <strong>
               <span>Order:</span>
               <span t-field="picking.sale_id.name"/>
               <t t-if="picking.sale_id.client_order_ref">
                 <span t-translation="off">(</span>
@@ -45,51 +50,40 @@
     </xpath>
     <xpath expr="//td/span[@t-field='line.quantity']" position="attributes">
       <attribute name="t-esc">lines_group['quantity']</attribute>
       <attribute name="t-field"/>
       <attribute name="t-options">{'widget': 'float', 'decimal_precision': 'Product Unit of Measure'}</attribute>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_subtotal']" position="before">
-      <t t-if="lines_group['quantity'] != l.quantity" id="picking_subtotal" groups="!account.group_show_line_subtotals_tax_included">
+      <t t-set="line_subtotal" t-value="l.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
+      <t t-set="line_subtotal" t-value="l.price_total" groups="account.group_show_line_subtotals_tax_included"/>
+      <t t-if="lines_group['quantity'] != l.quantity" id="picking_subtotal">
         <!-- Compute subtotal for that picking with discounts -->
-        <t t-set="line_picking_subtotal" t-value="l.quantity and lines_group['quantity'] * (l.price_subtotal / l.quantity) or 0.0"/>
+        <t t-set="line_picking_subtotal" t-value="l.quantity and lines_group['quantity'] * (line_subtotal / l.quantity) or 0.0"/>
         <t t-set="subtotal" t-value="(subtotal or 0.0) + line_picking_subtotal"/>
         <span t-esc="line_picking_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
       </t>
       <t t-else="">
-        <t t-set="subtotal" t-value="(subtotal or 0.0) + l.price_subtotal"/>
+        <t t-set="subtotal" t-value="(subtotal or 0.0) + line_subtotal"/>
       </t>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_subtotal']" position="attributes">
       <attribute name="t-if">lines_group['quantity'] == l.quantity</attribute>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_total']" position="attributes">
       <attribute name="t-if">lines_group['quantity'] == l.quantity</attribute>
     </xpath>
     <!-- Append subtotal row after invoice line row-->
-    <xpath expr="//t[@t-foreach='o.lines_grouped_by_picking()']//td[hasclass('o_price_total')]" position="after">
+    <xpath expr="//t[@t-foreach='lines_grouped']//td[hasclass('o_price_total')]" position="after">
       <tr t-if="picking != next_picking[0]">
         <td colspan="10" class="text-right">
           <strong>Subtotal:</strong>
           <strong t-esc="subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
         </td>
         <t t-set="subtotal" t-value="0.0"/>
       </tr>
-      <t t-set="last_picking" t-value="picking"/>
-    </xpath>
-    <!-- Replicate logic if B2C prices-->
-    <xpath expr="//td/span[@t-field='line.price_total']" position="before">
-      <t t-if="lines_group['quantity'] != l.quantity" groups="account.group_show_line_subtotals_tax_included">
-        <!-- Compute subtotal for that picking with discounts -->
-        <t t-set="line_picking_subtotal" t-value="l.quantity and lines_group['quantity'] * (l.price_total / l.quantity) or 0.0"/>
-        <t t-set="subtotal" t-value="(subtotal or 0.0) + line_picking_subtotal"/>
-        <span t-esc="line_picking_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
-      </t>
-      <t t-else="">
-        <t t-set="subtotal" t-value="(subtotal or 0.0) + l.price_total"/>
-      </t>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_total']" position="attributes">
       <attribute name="t-if">lines_group['quantity'] == l.quantity</attribute>
     </xpath>
   </template>
 </odoo>
```

## Comparing `odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/METADATA` & `odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/METADATA`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo13-addon-account-invoice-report-grouped-by-picking
-Version: 13.0.1.0.8
+Version: 13.0.1.1.0
 Summary: Print invoice lines grouped by picking
 Home-page: https://github.com/OCA/account-invoice-reporting
 Author: Tecnativa, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
@@ -62,22 +62,14 @@
 #. Deliver pickings related to each sale order.
 #. Go to *Sales > Invoicing > Sales to invoicing* and invoice these sale
    orders.
 #. Open invoice newly created and print it.
 #. Invoice report will group invoice lines and shows information about sales
    and pickings in every group.
 
-Known issues / Roadmap
-======================
-
-* As a result of the grouping by pickings, we don't support notes and descriptions.
-* Anyways, an invoice with no pickings should be printed as usual. The problem is
-  that in the current state of the report, a heavy refactoring is needed to be able to
-  fallback to the regular behavior in such case.
-
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/account-invoice-reporting/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
 `feedback <https://github.com/OCA/account-invoice-reporting/issues/new?body=module:%20account_invoice_report_grouped_by_picking%0Aversion:%2013.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
```

## Comparing `odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/RECORD` & `odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/RECORD`

 * *Files 16% similar despite different names*

```diff
@@ -1,21 +1,20 @@
-odoo/addons/account_invoice_report_grouped_by_picking/README.rst,sha256=tUOzcjtnx1QlJoUPceGKQ6ukcgVlOJDcOJPUF6zSbD0,4017
+odoo/addons/account_invoice_report_grouped_by_picking/README.rst,sha256=wN3lz48naaZ-8mSA1JAh0bI_Cq5sBvzz2SCRCMtpwFE,3667
 odoo/addons/account_invoice_report_grouped_by_picking/__init__.py,sha256=X9EJGOE2GtZbS0G82PtSXmWSZ_R8jEM0rlJTDliQjp4,21
-odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py,sha256=B9q_x7ry90HtZTHqArWIZNeR6jXXzjHuri29pNRrVwQ,662
+odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py,sha256=By5JOclttCd6gRjKaFPROcTmAD4K8vYlBGhEXIRWBZE,662
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/account_invoice_report_grouped_by_picking.pot,sha256=_Zyc1WzPKjEQiEtcccj8p5FBLvgrlnzjY_OjN0HgAd8,1431
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/es.po,sha256=tWIIC7fuSUQIm8Q3Du38rjrZa8KrDY-rNM3lINjAaBY,1769
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/pt.po,sha256=1yCepiwTze3bcYsS4ssl-0auHPSkUeLw9HFJmiCY0NI,1669
 odoo/addons/account_invoice_report_grouped_by_picking/models/__init__.py,sha256=9829nnQdRNsJmZEDfsGtCQQqM2W0JuYarPptYP2zJzU,27
-odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py,sha256=Clpkhqcr5Pf5DSRfaVIBf-jzKktdFAhx_zz-N4MXOKI,3405
+odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py,sha256=irk_qgertb8NxEWrcECaqBGOlNxTtH9HPveDb4LZCVA,5775
 odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst,sha256=u7X_KF1L48uBB4czzdfJyQvXGELnX32MpbPIBcY8KnY,195
 odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst,sha256=82ARWU3EdaEvvajAt1n6cV9n3Lke6HhMP3nep_Xx7Z0,317
-odoo/addons/account_invoice_report_grouped_by_picking/readme/ROADMAP.rst,sha256=MheG5RgkEXF5mSoPC3qSxQXnPeKbzDqw1mBBkKRzf-8,302
 odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst,sha256=L6CqrUPpcgpp71pKB3LiOzilAaj2ZDiuNB_fFxBAjuM,338
 odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
-odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html,sha256=uVY8XALE_1h1AEmTZeujX6gUXSuYd0yin-gEVnk84c8,13692
+odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html,sha256=sWMpK1RCLUcQTnIXwq6Lma-ah4onqR1JlEcT-DGISIo,13122
 odoo/addons/account_invoice_report_grouped_by_picking/tests/__init__.py,sha256=NNnN1-zIGuye0p_0vys1VmOZrygIGrrve7EVeFdEofY,49
 odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py,sha256=la2TofCEORkxZo0rDcCccFI2LEKBMP5n3FjWqnQGxws,11251
-odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml,sha256=IR-j1Xz1Si4jmw13RdIzi4LmmpvM0r_z4jFOBMUEaLg,6425
-odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/METADATA,sha256=qWEsLg6uhvYbcKEkWXqsce1uSF3jpVb9fzpp82-ZEt0,4662
-odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
-odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.0.8.dist-info/RECORD,,
+odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml,sha256=q6cEpoH3ha8eWaCDr4riuMVjAQXsckFTSNLeD2GZ-gY,5730
+odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/METADATA,sha256=b1zZEDPldsPK9ERUDT3kmrjvgRIdu2vzpsO5h92GVAs,4312
+odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo13_addon_account_invoice_report_grouped_by_picking-13.0.1.1.0.dist-info/RECORD,,
```

